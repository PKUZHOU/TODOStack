<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据同步测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>TODOStack 数据同步测试</h1>
    
    <div class="section">
        <h2>当前localStorage数据</h2>
        <button onclick="loadData()">刷新数据</button>
        <button onclick="clearData()">清空数据</button>
        <pre id="dataDisplay">点击"刷新数据"查看当前数据</pre>
    </div>
    
    <div class="section">
        <h2>添加测试任务</h2>
        <input type="text" id="testTask" placeholder="输入测试任务" style="padding: 8px; width: 200px;">
        <button onclick="addTestTask()">添加任务</button>
    </div>
    
    <div class="section">
        <h2>操作说明</h2>
        <p>1. 在这个页面添加测试任务</p>
        <p>2. 打开主应用（index.html）查看是否同步</p>
        <p>3. 打开Chrome插件查看是否同步</p>
        <p>4. 在任意一个地方修改数据，其他地方应该能看到变化</p>
    </div>

    <script>
        function loadData() {
            const data = localStorage.getItem('todostack_data');
            const display = document.getElementById('dataDisplay');
            
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    display.textContent = JSON.stringify(parsed, null, 2);
                } catch (error) {
                    display.textContent = '数据解析错误: ' + error.message;
                }
            } else {
                display.textContent = '没有找到数据';
            }
        }
        
        function clearData() {
            localStorage.removeItem('todostack_data');
            localStorage.removeItem('todostack_last_date');
            loadData();
            alert('数据已清空');
        }
        
        function addTestTask() {
            const input = document.getElementById('testTask');
            const taskText = input.value.trim();
            
            if (!taskText) {
                alert('请输入任务内容');
                return;
            }
            
            // 获取现有数据
            let data = {
                stack: [],
                completedTasks: [],
                todayTaskCount: 0
            };
            
            const existing = localStorage.getItem('todostack_data');
            if (existing) {
                try {
                    data = JSON.parse(existing);
                } catch (error) {
                    console.error('解析现有数据失败:', error);
                }
            }
            
            // 添加新任务
            const newTask = {
                id: Date.now(),
                title: taskText,
                content: taskText,
                priority: 'medium',
                tags: ['测试'],
                progress: 0,
                progressHistory: [],
                timestamp: new Date().toISOString(),
                index: data.stack.length
            };
            
            data.stack.push(newTask);
            data.todayTaskCount = (data.todayTaskCount || 0) + 1;
            data.lastUpdated = new Date().toISOString();
            
            // 保存数据
            localStorage.setItem('todostack_data', JSON.stringify(data));
            
            input.value = '';
            loadData();
            alert('测试任务已添加');
        }
        
        // 页面加载时显示数据
        window.addEventListener('load', loadData);
        
        // 监听localStorage变化
        window.addEventListener('storage', function(e) {
            if (e.key === 'todostack_data') {
                console.log('检测到数据变化，自动刷新');
                loadData();
            }
        });
    </script>
</body>
</html> 